---
- name: Generate ssh key
  ansible.builtin.user:
    name: vagrant
    generate_ssh_key: yes
    ssh_key_bits: 2048
    ssh_key_file: .ssh/id_rsa

- name: view ssh key pub
  shell: cat /home/vagrant/.ssh/id_rsa.pub
  register: ssh_key_client

- name: input ssh key client in server file
  ansible.builtin.lineinfile:
    path: /home/borg/.ssh/authorized_keys
    line: '{{ssh_key_client.stdout}}' 
  delegate_to: server

- name: Change file permissions
  ansible.builtin.file:
    path: '{{item.path}}'
    owner: borg
    group: borg
    mode: '{{item.mode}}'
  loop:
    - path: /home/borg/.ssh
      mode: 700
    - path: /home/borg/.ssh/authorized_keys
      mode: 600
  delegate_to: server

- name: Copy etc/systemd/system
  ansible.builtin.copy:
    src: '{{item}}'
    dest: /etc/systemd/system
    owner: root
    group: root
    mode: 755
  loop:
    - borg-backup.timer
    - borg-backup.service
- name: start service borg-backup.timer
  ansible.builtin.systemd:
    state: started
    enabled: true
    daemon_reload: true
    name: borg-backup.timer



